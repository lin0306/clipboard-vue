"use strict";var ye=Object.defineProperty;var be=(i,e,t)=>e in i?ye(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var h=(i,e,t)=>be(i,typeof e!="symbol"?e+"":e,t);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const m=require("electron"),U=require("node:url"),d=require("node:path"),E=require("node:fs"),Se=require("better-sqlite3"),L=require("path"),ve=require("child_process"),W=require("os"),P=require("fs"),_e=require("util"),ie=require("events"),Oe=require("http"),we=require("https");var y=typeof document<"u"?document.currentScript:null;function Te(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}const se=P,R=L;var Le={findAndReadPackageJson:Ne,tryReadJsonAt:T};function Ne(){return T(De())||T(Ae())||T(process.resourcesPath,"app.asar")||T(process.resourcesPath,"app")||T(process.cwd())||{name:void 0,version:void 0}}function T(...i){if(i[0])try{const e=R.join(...i),t=Re("package.json",e);if(!t)return;const r=JSON.parse(se.readFileSync(t,"utf8")),n=(r==null?void 0:r.productName)||(r==null?void 0:r.name);return!n||n.toLowerCase()==="electron"?void 0:n?{name:n,version:r==null?void 0:r.version}:void 0}catch{return}}function Re(i,e){let t=e;for(;;){const r=R.parse(t),n=r.root,s=r.dir;if(se.existsSync(R.join(t,i)))return R.resolve(R.join(t,i));if(t===n)return null;t=s}}function Ae(){const i=process.argv.filter(t=>t.indexOf("--user-data-dir=")===0);return i.length===0||typeof i[0]!="string"?null:i[0].replace("--user-data-dir=","")}function De(){var i;try{return(i=require.main)==null?void 0:i.filename}catch{return}}const Ie=ve,_=W,w=L,Fe=Le;let Pe=class{constructor(){h(this,"appName");h(this,"appPackageJson");h(this,"platform",process.platform)}getAppLogPath(e=this.getAppName()){return this.platform==="darwin"?w.join(this.getSystemPathHome(),"Library/Logs",e):w.join(this.getAppUserDataPath(e),"logs")}getAppName(){var t;const e=this.appName||((t=this.getAppPackageJson())==null?void 0:t.name);if(!e)throw new Error("electron-log can't determine the app name. It tried these methods:\n1. Use `electron.app.name`\n2. Use productName or name from the nearest package.json`\nYou can also set it through log.transports.file.setAppName()");return e}getAppPackageJson(){return typeof this.appPackageJson!="object"&&(this.appPackageJson=Fe.findAndReadPackageJson()),this.appPackageJson}getAppUserDataPath(e=this.getAppName()){return e?w.join(this.getSystemPathAppData(),e):void 0}getAppVersion(){var e;return(e=this.getAppPackageJson())==null?void 0:e.version}getElectronLogPath(){return this.getAppLogPath()}getMacOsVersion(){const e=Number(_.release().split(".")[0]);return e<=19?`10.${e-4}`:e-9}getOsVersion(){let e=_.type().replace("_"," "),t=_.release();return e==="Darwin"&&(e="macOS",t=this.getMacOsVersion()),`${e} ${t}`}getPathVariables(){const e=this.getAppName(),t=this.getAppVersion(),r=this;return{appData:this.getSystemPathAppData(),appName:e,appVersion:t,get electronDefaultDir(){return r.getElectronLogPath()},home:this.getSystemPathHome(),libraryDefaultDir:this.getAppLogPath(e),libraryTemplate:this.getAppLogPath("{appName}"),temp:this.getSystemPathTemp(),userData:this.getAppUserDataPath(e)}}getSystemPathAppData(){const e=this.getSystemPathHome();switch(this.platform){case"darwin":return w.join(e,"Library/Application Support");case"win32":return process.env.APPDATA||w.join(e,"AppData/Roaming");default:return process.env.XDG_CONFIG_HOME||w.join(e,".config")}}getSystemPathHome(){var e;return((e=_.homedir)==null?void 0:e.call(_))||process.env.HOME}getSystemPathTemp(){return _.tmpdir()}getVersions(){return{app:`${this.getAppName()} ${this.getAppVersion()}`,electron:void 0,os:this.getOsVersion()}}isDev(){return process.env.NODE_ENV==="development"||process.env.ELECTRON_IS_DEV==="1"}isElectron(){return!!process.versions.electron}onAppEvent(e,t){}onAppReady(e){e()}onEveryWebContentsEvent(e,t){}onIpc(e,t){}onIpcInvoke(e,t){}openUrl(e,t=console.error){const n={darwin:"open",win32:"start",linux:"xdg-open"}[process.platform]||"xdg-open";Ie.exec(`${n} ${e}`,{},s=>{s&&t(s)})}setAppName(e){this.appName=e}setPlatform(e){this.platform=e}setPreloadFileForSessions({filePath:e,includeFutureSession:t=!0,getSessions:r=()=>[]}){}sendIpc(e,t){}showErrorBox(e,t){}};var Ce=Pe;const $e=L,xe=Ce;let je=class extends xe{constructor({electron:t}={}){super();h(this,"electron");this.electron=t}getAppName(){var r,n;let t;try{t=this.appName||((r=this.electron.app)==null?void 0:r.name)||((n=this.electron.app)==null?void 0:n.getName())}catch{}return t||super.getAppName()}getAppUserDataPath(t){return this.getPath("userData")||super.getAppUserDataPath(t)}getAppVersion(){var r;let t;try{t=(r=this.electron.app)==null?void 0:r.getVersion()}catch{}return t||super.getAppVersion()}getElectronLogPath(){return this.getPath("logs")||super.getElectronLogPath()}getPath(t){var r;try{return(r=this.electron.app)==null?void 0:r.getPath(t)}catch{return}}getVersions(){return{app:`${this.getAppName()} ${this.getAppVersion()}`,electron:`Electron ${process.versions.electron}`,os:this.getOsVersion()}}getSystemPathAppData(){return this.getPath("appData")||super.getSystemPathAppData()}isDev(){var t;return((t=this.electron.app)==null?void 0:t.isPackaged)!==void 0?!this.electron.app.isPackaged:typeof process.execPath=="string"?$e.basename(process.execPath).toLowerCase().startsWith("electron"):super.isDev()}onAppEvent(t,r){var n;return(n=this.electron.app)==null||n.on(t,r),()=>{var s;(s=this.electron.app)==null||s.off(t,r)}}onAppReady(t){var r,n,s;(r=this.electron.app)!=null&&r.isReady()?t():(n=this.electron.app)!=null&&n.once?(s=this.electron.app)==null||s.once("ready",t):t()}onEveryWebContentsEvent(t,r){var s,o,a;return(o=(s=this.electron.webContents)==null?void 0:s.getAllWebContents())==null||o.forEach(l=>{l.on(t,r)}),(a=this.electron.app)==null||a.on("web-contents-created",n),()=>{var l,p;(l=this.electron.webContents)==null||l.getAllWebContents().forEach(f=>{f.off(t,r)}),(p=this.electron.app)==null||p.off("web-contents-created",n)};function n(l,p){p.on(t,r)}}onIpc(t,r){var n;(n=this.electron.ipcMain)==null||n.on(t,r)}onIpcInvoke(t,r){var n,s;(s=(n=this.electron.ipcMain)==null?void 0:n.handle)==null||s.call(n,t,r)}openUrl(t,r=console.error){var n;(n=this.electron.shell)==null||n.openExternal(t).catch(r)}setPreloadFileForSessions({filePath:t,includeFutureSession:r=!0,getSessions:n=()=>{var s;return[(s=this.electron.session)==null?void 0:s.defaultSession]}}){for(const o of n().filter(Boolean))s(o);r&&this.onAppEvent("session-created",o=>{s(o)});function s(o){typeof o.registerPreloadScript=="function"?o.registerPreloadScript({filePath:t,id:"electron-log-preload",type:"frame"}):o.setPreloads([...o.getPreloads(),t])}}sendIpc(t,r){var n,s;(s=(n=this.electron.BrowserWindow)==null?void 0:n.getAllWindows())==null||s.forEach(o=>{var a,l;((a=o.webContents)==null?void 0:a.isDestroyed())===!1&&((l=o.webContents)==null?void 0:l.isCrashed())===!1&&o.webContents.send(t,r)})}showErrorBox(t,r){var n;(n=this.electron.dialog)==null||n.showErrorBox(t,r)}};var Me=je,oe={exports:{}};(function(i){let e={};try{e=require("electron")}catch{}e.ipcRenderer&&t(e),i.exports=t;function t({contextBridge:r,ipcRenderer:n}){if(!n)return;n.on("__ELECTRON_LOG_IPC__",(o,a)=>{window.postMessage({cmd:"message",...a})}),n.invoke("__ELECTRON_LOG__",{cmd:"getOptions"}).catch(o=>console.error(new Error(`electron-log isn't initialized in the main process. Please call log.initialize() before. ${o.message}`)));const s={sendToMain(o){try{n.send("__ELECTRON_LOG__",o)}catch(a){console.error("electronLog.sendToMain ",a,"data:",o),n.send("__ELECTRON_LOG__",{cmd:"errorHandler",error:{message:a==null?void 0:a.message,stack:a==null?void 0:a.stack},errorName:"sendToMain"})}},log(...o){s.sendToMain({data:o,level:"info"})}};for(const o of["error","warn","info","verbose","debug","silly"])s[o]=(...a)=>s.sendToMain({data:a,level:o});if(r&&process.contextIsolated)try{r.exposeInMainWorld("__electronLog",s)}catch{}typeof window=="object"?window.__electronLog=s:__electronLog=s}})(oe);var Ue=oe.exports;const G=P,We=W,Y=L,ke=Ue;var ze={initialize({externalApi:i,getSessions:e,includeFutureSession:t,logger:r,preload:n=!0,spyRendererConsole:s=!1}){i.onAppReady(()=>{try{n&&Ve({externalApi:i,getSessions:e,includeFutureSession:t,preloadOption:n}),s&&qe({externalApi:i,logger:r})}catch(o){r.warn(o)}})}};function Ve({externalApi:i,getSessions:e,includeFutureSession:t,preloadOption:r}){let n=typeof r=="string"?r:void 0;try{n=Y.resolve(__dirname,"../renderer/electron-log-preload.js")}catch{}if(!n||!G.existsSync(n)){n=Y.join(i.getAppUserDataPath()||We.tmpdir(),"electron-log-preload.js");const s=`
      try {
        (${ke.toString()})(require('electron'));
      } catch(e) {
        console.error(e);
      }
    `;G.writeFileSync(n,s,"utf8")}i.setPreloadFileForSessions({filePath:n,includeFutureSession:t,getSessions:e})}function qe({externalApi:i,logger:e}){const t=["verbose","info","warning","error"];i.onEveryWebContentsEvent("console-message",(r,n,s)=>{e.processMessage({data:[s],level:t[n],variables:{processType:"renderer"}})})}var Be=He;function He(i){return Object.defineProperties(e,{defaultLabel:{value:"",writable:!0},labelPadding:{value:!0,writable:!0},maxLabelLength:{value:0,writable:!0},labelLength:{get(){switch(typeof e.labelPadding){case"boolean":return e.labelPadding?e.maxLabelLength:0;case"number":return e.labelPadding;default:return 0}}}});function e(t){e.maxLabelLength=Math.max(e.maxLabelLength,t.length);const r={};for(const n of i.levels)r[n]=(...s)=>i.logData(s,{level:n,scope:t});return r.log=r.info,r}}let Je=class{constructor({processMessage:e}){this.processMessage=e,this.buffer=[],this.enabled=!1,this.begin=this.begin.bind(this),this.commit=this.commit.bind(this),this.reject=this.reject.bind(this)}addMessage(e){this.buffer.push(e)}begin(){this.enabled=[]}commit(){this.enabled=!1,this.buffer.forEach(e=>this.processMessage(e)),this.buffer=[]}reject(){this.enabled=!1,this.buffer=[]}};var Ge=Je;const Ye=Be,Xe=Ge;var v;let Ke=(v=class{constructor({allowUnknownLevel:e=!1,dependencies:t={},errorHandler:r,eventLogger:n,initializeFn:s,isDev:o=!1,levels:a=["error","warn","info","verbose","debug","silly"],logId:l,transportFactories:p={},variables:f}={}){h(this,"dependencies",{});h(this,"errorHandler",null);h(this,"eventLogger",null);h(this,"functions",{});h(this,"hooks",[]);h(this,"isDev",!1);h(this,"levels",null);h(this,"logId",null);h(this,"scope",null);h(this,"transports",{});h(this,"variables",{});this.addLevel=this.addLevel.bind(this),this.create=this.create.bind(this),this.initialize=this.initialize.bind(this),this.logData=this.logData.bind(this),this.processMessage=this.processMessage.bind(this),this.allowUnknownLevel=e,this.buffering=new Xe(this),this.dependencies=t,this.initializeFn=s,this.isDev=o,this.levels=a,this.logId=l,this.scope=Ye(this),this.transportFactories=p,this.variables=f||{};for(const g of this.levels)this.addLevel(g,!1);this.log=this.info,this.functions.log=this.log,this.errorHandler=r,r==null||r.setOptions({...t,logFn:this.error}),this.eventLogger=n,n==null||n.setOptions({...t,logger:this});for(const[g,b]of Object.entries(p))this.transports[g]=b(this,t);v.instances[l]=this}static getInstance({logId:e}){return this.instances[e]||this.instances.default}addLevel(e,t=this.levels.length){t!==!1&&this.levels.splice(t,0,e),this[e]=(...r)=>this.logData(r,{level:e}),this.functions[e]=this[e]}catchErrors(e){return this.processMessage({data:["log.catchErrors is deprecated. Use log.errorHandler instead"],level:"warn"},{transports:["console"]}),this.errorHandler.startCatching(e)}create(e){return typeof e=="string"&&(e={logId:e}),new v({dependencies:this.dependencies,errorHandler:this.errorHandler,initializeFn:this.initializeFn,isDev:this.isDev,transportFactories:this.transportFactories,variables:{...this.variables},...e})}compareLevels(e,t,r=this.levels){const n=r.indexOf(e),s=r.indexOf(t);return s===-1||n===-1?!0:s<=n}initialize(e={}){this.initializeFn({logger:this,...this.dependencies,...e})}logData(e,t={}){this.buffering.enabled?this.buffering.addMessage({data:e,...t}):this.processMessage({data:e,...t})}processMessage(e,{transports:t=this.transports}={}){if(e.cmd==="errorHandler"){this.errorHandler.handle(e.error,{errorName:e.errorName,processType:"renderer",showDialog:!!e.showDialog});return}let r=e.level;this.allowUnknownLevel||(r=this.levels.includes(e.level)?e.level:"info");const n={date:new Date,logId:this.logId,...e,level:r,variables:{...this.variables,...e.variables}};for(const[s,o]of this.transportEntries(t))if(!(typeof o!="function"||o.level===!1)&&this.compareLevels(o.level,e.level))try{const a=this.hooks.reduce((l,p)=>l&&p(l,o,s),n);a&&o({...a,data:[...a.data]})}catch(a){this.processInternalErrorFn(a)}}processInternalErrorFn(e){}transportEntries(e=this.transports){return(Array.isArray(e)?e:Object.entries(e)).map(r=>{switch(typeof r){case"string":return this.transports[r]?[r,this.transports[r]]:null;case"function":return[r.name,r];default:return Array.isArray(r)?r:null}}).filter(Boolean)}},h(v,"instances",{}),v);var Qe=Ke;let Ze=class{constructor({externalApi:e,logFn:t=void 0,onError:r=void 0,showDialog:n=void 0}={}){h(this,"externalApi");h(this,"isActive",!1);h(this,"logFn");h(this,"onError");h(this,"showDialog",!0);this.createIssue=this.createIssue.bind(this),this.handleError=this.handleError.bind(this),this.handleRejection=this.handleRejection.bind(this),this.setOptions({externalApi:e,logFn:t,onError:r,showDialog:n}),this.startCatching=this.startCatching.bind(this),this.stopCatching=this.stopCatching.bind(this)}handle(e,{logFn:t=this.logFn,onError:r=this.onError,processType:n="browser",showDialog:s=this.showDialog,errorName:o=""}={}){var a;e=et(e);try{if(typeof r=="function"){const l=((a=this.externalApi)==null?void 0:a.getVersions())||{},p=this.createIssue;if(r({createIssue:p,error:e,errorName:o,processType:n,versions:l})===!1)return}o?t(o,e):t(e),s&&!o.includes("rejection")&&this.externalApi&&this.externalApi.showErrorBox(`A JavaScript error occurred in the ${n} process`,e.stack)}catch{console.error(e)}}setOptions({externalApi:e,logFn:t,onError:r,showDialog:n}){typeof e=="object"&&(this.externalApi=e),typeof t=="function"&&(this.logFn=t),typeof r=="function"&&(this.onError=r),typeof n=="boolean"&&(this.showDialog=n)}startCatching({onError:e,showDialog:t}={}){this.isActive||(this.isActive=!0,this.setOptions({onError:e,showDialog:t}),process.on("uncaughtException",this.handleError),process.on("unhandledRejection",this.handleRejection))}stopCatching(){this.isActive=!1,process.removeListener("uncaughtException",this.handleError),process.removeListener("unhandledRejection",this.handleRejection)}createIssue(e,t){var r;(r=this.externalApi)==null||r.openUrl(`${e}?${new URLSearchParams(t).toString()}`)}handleError(e){this.handle(e,{errorName:"Unhandled"})}handleRejection(e){const t=e instanceof Error?e:new Error(JSON.stringify(e));this.handle(t,{errorName:"Unhandled rejection"})}};function et(i){if(i instanceof Error)return i;if(i&&typeof i=="object"){if(i.message)return Object.assign(new Error(i.message),i);try{return new Error(JSON.stringify(i))}catch(e){return new Error(`Couldn't normalize error ${String(i)}: ${e}`)}}return new Error(`Can't normalize error ${String(i)}`)}var tt=Ze;let rt=class{constructor(e={}){h(this,"disposers",[]);h(this,"format","{eventSource}#{eventName}:");h(this,"formatters",{app:{"certificate-error":({args:e})=>this.arrayToObject(e.slice(1,4),["url","error","certificate"]),"child-process-gone":({args:e})=>e.length===1?e[0]:e,"render-process-gone":({args:[e,t]})=>t&&typeof t=="object"?{...t,...this.getWebContentsDetails(e)}:[]},webContents:{"console-message":({args:[e,t,r,n]})=>{if(!(e<3))return{message:t,source:`${n}:${r}`}},"did-fail-load":({args:e})=>this.arrayToObject(e,["errorCode","errorDescription","validatedURL","isMainFrame","frameProcessId","frameRoutingId"]),"did-fail-provisional-load":({args:e})=>this.arrayToObject(e,["errorCode","errorDescription","validatedURL","isMainFrame","frameProcessId","frameRoutingId"]),"plugin-crashed":({args:e})=>this.arrayToObject(e,["name","version"]),"preload-error":({args:e})=>this.arrayToObject(e,["preloadPath","error"])}});h(this,"events",{app:{"certificate-error":!0,"child-process-gone":!0,"render-process-gone":!0},webContents:{"did-fail-load":!0,"did-fail-provisional-load":!0,"plugin-crashed":!0,"preload-error":!0,unresponsive:!0}});h(this,"externalApi");h(this,"level","error");h(this,"scope","");this.setOptions(e)}setOptions({events:e,externalApi:t,level:r,logger:n,format:s,formatters:o,scope:a}){typeof e=="object"&&(this.events=e),typeof t=="object"&&(this.externalApi=t),typeof r=="string"&&(this.level=r),typeof n=="object"&&(this.logger=n),(typeof s=="string"||typeof s=="function")&&(this.format=s),typeof o=="object"&&(this.formatters=o),typeof a=="string"&&(this.scope=a)}startLogging(e={}){this.setOptions(e),this.disposeListeners();for(const t of this.getEventNames(this.events.app))this.disposers.push(this.externalApi.onAppEvent(t,(...r)=>{this.handleEvent({eventSource:"app",eventName:t,handlerArgs:r})}));for(const t of this.getEventNames(this.events.webContents))this.disposers.push(this.externalApi.onEveryWebContentsEvent(t,(...r)=>{this.handleEvent({eventSource:"webContents",eventName:t,handlerArgs:r})}))}stopLogging(){this.disposeListeners()}arrayToObject(e,t){const r={};return t.forEach((n,s)=>{r[n]=e[s]}),e.length>t.length&&(r.unknownArgs=e.slice(t.length)),r}disposeListeners(){this.disposers.forEach(e=>e()),this.disposers=[]}formatEventLog({eventName:e,eventSource:t,handlerArgs:r}){var f;const[n,...s]=r;if(typeof this.format=="function")return this.format({args:s,event:n,eventName:e,eventSource:t});const o=(f=this.formatters[t])==null?void 0:f[e];let a=s;if(typeof o=="function"&&(a=o({args:s,event:n,eventName:e,eventSource:t})),!a)return;const l={};return Array.isArray(a)?l.args=a:typeof a=="object"&&Object.assign(l,a),t==="webContents"&&Object.assign(l,this.getWebContentsDetails(n==null?void 0:n.sender)),[this.format.replace("{eventSource}",t==="app"?"App":"WebContents").replace("{eventName}",e),l]}getEventNames(e){return!e||typeof e!="object"?[]:Object.entries(e).filter(([t,r])=>r).map(([t])=>t)}getWebContentsDetails(e){if(!(e!=null&&e.loadURL))return{};try{return{webContents:{id:e.id,url:e.getURL()}}}catch{return{}}}handleEvent({eventName:e,eventSource:t,handlerArgs:r}){var s;const n=this.formatEventLog({eventName:e,eventSource:t,handlerArgs:r});if(n){const o=this.scope?this.logger.scope(this.scope):this.logger;(s=o==null?void 0:o[this.level])==null||s.call(o,...n)}}};var nt=rt,C={transform:it};function it({logger:i,message:e,transport:t,initialData:r=(e==null?void 0:e.data)||[],transforms:n=t==null?void 0:t.transforms}){return n.reduce((s,o)=>typeof o=="function"?o({data:s,logger:i,message:e,transport:t}):s,r)}const{transform:st}=C;var ae={concatFirstStringElements:ot,format({message:i,logger:e,transport:t,data:r=i==null?void 0:i.data}){switch(typeof t.format){case"string":return st({message:i,logger:e,transforms:[lt,ct,pt],transport:t,initialData:[t.format,...r]});case"function":return t.format({data:r,level:(i==null?void 0:i.level)||"info",logger:e,message:i,transport:t});default:return r}}};function ot({data:i}){return typeof i[0]!="string"||typeof i[1]!="string"||i[0].match(/%[1cdfiOos]/)?i:[`${i[0]} ${i[1]}`,...i.slice(2)]}function at(i){const e=Math.abs(i),t=i>0?"-":"+",r=Math.floor(e/60).toString().padStart(2,"0"),n=(e%60).toString().padStart(2,"0");return`${t}${r}:${n}`}function ct({data:i,logger:e,message:t}){const{defaultLabel:r,labelLength:n}=(e==null?void 0:e.scope)||{},s=i[0];let o=t.scope;o||(o=r);let a;return o===""?a=n>0?"".padEnd(n+3):"":typeof o=="string"?a=` (${o})`.padEnd(n+3):a="",i[0]=s.replace("{scope}",a),i}function lt({data:i,message:e}){let t=i[0];if(typeof t!="string")return i;t=t.replace("{level}]",`${e.level}]`.padEnd(6," "));const r=e.date||new Date;return i[0]=t.replace(/\{(\w+)}/g,(n,s)=>{var o;switch(s){case"level":return e.level||"info";case"logId":return e.logId;case"y":return r.getFullYear().toString(10);case"m":return(r.getMonth()+1).toString(10).padStart(2,"0");case"d":return r.getDate().toString(10).padStart(2,"0");case"h":return r.getHours().toString(10).padStart(2,"0");case"i":return r.getMinutes().toString(10).padStart(2,"0");case"s":return r.getSeconds().toString(10).padStart(2,"0");case"ms":return r.getMilliseconds().toString(10).padStart(3,"0");case"z":return at(r.getTimezoneOffset());case"iso":return r.toISOString();default:return((o=e.variables)==null?void 0:o[s])||n}}).trim(),i}function pt({data:i}){const e=i[0];if(typeof e!="string")return i;if(e.lastIndexOf("{text}")===e.length-6)return i[0]=e.replace(/\s?{text}/,""),i[0]===""&&i.shift(),i;const r=e.split("{text}");let n=[];return r[0]!==""&&n.push(r[0]),n=n.concat(i.slice(1)),r[1]!==""&&n.push(r[1]),n}var ce={exports:{}};(function(i){const e=_e;i.exports={serialize:r,maxDepth({data:n,transport:s,depth:o=(s==null?void 0:s.depth)??6}){if(!n)return n;if(o<1)return Array.isArray(n)?"[array]":typeof n=="object"&&n?"[object]":n;if(Array.isArray(n))return n.map(l=>i.exports.maxDepth({data:l,depth:o-1}));if(typeof n!="object"||n&&typeof n.toISOString=="function")return n;if(n===null)return null;if(n instanceof Error)return n;const a={};for(const l in n)Object.prototype.hasOwnProperty.call(n,l)&&(a[l]=i.exports.maxDepth({data:n[l],depth:o-1}));return a},toJSON({data:n}){return JSON.parse(JSON.stringify(n,t()))},toString({data:n,transport:s}){const o=(s==null?void 0:s.inspectOptions)||{},a=n.map(l=>{if(l!==void 0)try{const p=JSON.stringify(l,t(),"  ");return p===void 0?void 0:JSON.parse(p)}catch{return l}});return e.formatWithOptions(o,...a)}};function t(n={}){const s=new WeakSet;return function(o,a){if(typeof a=="object"&&a!==null){if(s.has(a))return;s.add(a)}return r(o,a,n)}}function r(n,s,o={}){const a=(o==null?void 0:o.serializeMapAndSet)!==!1;return s instanceof Error?s.stack:s&&(typeof s=="function"?`[function] ${s.toString()}`:s instanceof Date?s.toISOString():a&&s instanceof Map&&Object.fromEntries?Object.fromEntries(s):a&&s instanceof Set&&Array.from?Array.from(s):s)}})(ce);var k=ce.exports,q={applyAnsiStyles({data:i}){return X(i,ft,ht)},removeStyles({data:i}){return X(i,()=>"")}};const le={unset:"\x1B[0m",black:"\x1B[30m",red:"\x1B[31m",green:"\x1B[32m",yellow:"\x1B[33m",blue:"\x1B[34m",magenta:"\x1B[35m",cyan:"\x1B[36m",white:"\x1B[37m"};function ft(i){const e=i.replace(/color:\s*(\w+).*/,"$1").toLowerCase();return le[e]||""}function ht(i){return i+le.unset}function X(i,e,t){const r={};return i.reduce((n,s,o,a)=>{if(r[o])return n;if(typeof s=="string"){let l=o,p=!1;s=s.replace(/%[1cdfiOos]/g,f=>{if(l+=1,f!=="%c")return f;const g=a[l];return typeof g=="string"?(r[l]=!0,p=!0,e(g,s)):f}),p&&t&&(s=t(s))}return n.push(s),n},[])}const{concatFirstStringElements:ut,format:dt}=ae,{maxDepth:gt,toJSON:mt}=k,{applyAnsiStyles:Et,removeStyles:yt}=q,{transform:bt}=C,K={error:console.error,warn:console.warn,info:console.info,verbose:console.info,debug:console.debug,silly:console.debug,log:console.log};var St=pe;const vt=process.platform==="win32"?">":"›",B=`%c{h}:{i}:{s}.{ms}{scope}%c ${vt} {text}`;Object.assign(pe,{DEFAULT_FORMAT:B});function pe(i){return Object.assign(e,{format:B,level:"silly",transforms:[_t,dt,wt,ut,gt,mt],useStyles:process.env.FORCE_STYLES,writeFn({message:t}){(K[t.level]||K.info)(...t.data)}});function e(t){const r=bt({logger:i,message:t,transport:e});e.writeFn({message:{...t,data:r}})}}function _t({data:i,message:e,transport:t}){return t.format!==B?i:[`color:${Tt(e.level)}`,"color:unset",...i]}function Ot(i,e){if(typeof i=="boolean")return i;const r=e==="error"||e==="warn"?process.stderr:process.stdout;return r&&r.isTTY}function wt(i){const{message:e,transport:t}=i;return(Ot(t.useStyles,e.level)?Et:yt)(i)}function Tt(i){const e={error:"red",warn:"yellow",info:"cyan",default:"unset"};return e[i]||e.default}const Lt=ie,S=P,Q=W;let Nt=class extends Lt{constructor({path:t,writeOptions:r={encoding:"utf8",flag:"a",mode:438},writeAsync:n=!1}){super();h(this,"asyncWriteQueue",[]);h(this,"bytesWritten",0);h(this,"hasActiveAsyncWriting",!1);h(this,"path",null);h(this,"initialSize");h(this,"writeOptions",null);h(this,"writeAsync",!1);this.path=t,this.writeOptions=r,this.writeAsync=n}get size(){return this.getSize()}clear(){try{return S.writeFileSync(this.path,"",{mode:this.writeOptions.mode,flag:"w"}),this.reset(),!0}catch(t){return t.code==="ENOENT"?!0:(this.emit("error",t,this),!1)}}crop(t){try{const r=Rt(this.path,t||4096);this.clear(),this.writeLine(`[log cropped]${Q.EOL}${r}`)}catch(r){this.emit("error",new Error(`Couldn't crop file ${this.path}. ${r.message}`),this)}}getSize(){if(this.initialSize===void 0)try{const t=S.statSync(this.path);this.initialSize=t.size}catch{this.initialSize=0}return this.initialSize+this.bytesWritten}increaseBytesWrittenCounter(t){this.bytesWritten+=Buffer.byteLength(t,this.writeOptions.encoding)}isNull(){return!1}nextAsyncWrite(){const t=this;if(this.hasActiveAsyncWriting||this.asyncWriteQueue.length===0)return;const r=this.asyncWriteQueue.join("");this.asyncWriteQueue=[],this.hasActiveAsyncWriting=!0,S.writeFile(this.path,r,this.writeOptions,n=>{t.hasActiveAsyncWriting=!1,n?t.emit("error",new Error(`Couldn't write to ${t.path}. ${n.message}`),this):t.increaseBytesWrittenCounter(r),t.nextAsyncWrite()})}reset(){this.initialSize=void 0,this.bytesWritten=0}toString(){return this.path}writeLine(t){if(t+=Q.EOL,this.writeAsync){this.asyncWriteQueue.push(t),this.nextAsyncWrite();return}try{S.writeFileSync(this.path,t,this.writeOptions),this.increaseBytesWrittenCounter(t)}catch(r){this.emit("error",new Error(`Couldn't write to ${this.path}. ${r.message}`),this)}}};var fe=Nt;function Rt(i,e){const t=Buffer.alloc(e),r=S.statSync(i),n=Math.min(r.size,e),s=Math.max(0,r.size-e),o=S.openSync(i,"r"),a=S.readSync(o,t,0,n,s);return S.closeSync(o),t.toString("utf8",0,a)}const At=fe;let Dt=class extends At{clear(){}crop(){}getSize(){return 0}isNull(){return!0}writeLine(){}};var It=Dt;const Ft=ie,Z=P,ee=L,Pt=fe,Ct=It;let $t=class extends Ft{constructor(){super();h(this,"store",{});this.emitError=this.emitError.bind(this)}provide({filePath:t,writeOptions:r={},writeAsync:n=!1}){let s;try{if(t=ee.resolve(t),this.store[t])return this.store[t];s=this.createFile({filePath:t,writeOptions:r,writeAsync:n})}catch(o){s=new Ct({path:t}),this.emitError(o,s)}return s.on("error",this.emitError),this.store[t]=s,s}createFile({filePath:t,writeOptions:r,writeAsync:n}){return this.testFileWriting({filePath:t,writeOptions:r}),new Pt({path:t,writeOptions:r,writeAsync:n})}emitError(t,r){this.emit("error",t,r)}testFileWriting({filePath:t,writeOptions:r}){Z.mkdirSync(ee.dirname(t),{recursive:!0}),Z.writeFileSync(t,"",{flag:"a",mode:r.mode})}};var xt=$t;const $=P,jt=W,N=L,Mt=xt,{transform:Ut}=C,{removeStyles:Wt}=q,{format:kt,concatFirstStringElements:zt}=ae,{toString:Vt}=k;var qt=Ht;const Bt=new Mt;function Ht(i,{registry:e=Bt,externalApi:t}={}){let r;return e.listenerCount("error")<1&&e.on("error",(p,f)=>{o(`Can't write to ${f}`,p)}),Object.assign(n,{fileName:Jt(i.variables.processType),format:"[{y}-{m}-{d} {h}:{i}:{s}.{ms}] [{level}]{scope} {text}",getFile:a,inspectOptions:{depth:5},level:"silly",maxSize:1024**2,readAllLogs:l,sync:!0,transforms:[Wt,kt,zt,Vt],writeOptions:{flag:"a",mode:438,encoding:"utf8"},archiveLogFn(p){const f=p.toString(),g=N.parse(f);try{$.renameSync(f,N.join(g.dir,`${g.name}.old${g.ext}`))}catch(b){o("Could not rotate log",b);const Ee=Math.round(n.maxSize/4);p.crop(Math.min(Ee,256*1024))}},resolvePathFn(p){return N.join(p.libraryDefaultDir,p.fileName)},setAppName(p){i.dependencies.externalApi.setAppName(p)}});function n(p){const f=a(p);n.maxSize>0&&f.size>n.maxSize&&(n.archiveLogFn(f),f.reset());const b=Ut({logger:i,message:p,transport:n});f.writeLine(b)}function s(){r||(r=Object.create(Object.prototype,{...Object.getOwnPropertyDescriptors(t.getPathVariables()),fileName:{get(){return n.fileName},enumerable:!0}}),typeof n.archiveLog=="function"&&(n.archiveLogFn=n.archiveLog,o("archiveLog is deprecated. Use archiveLogFn instead")),typeof n.resolvePath=="function"&&(n.resolvePathFn=n.resolvePath,o("resolvePath is deprecated. Use resolvePathFn instead")))}function o(p,f=null,g="error"){const b=[`electron-log.transports.file: ${p}`];f&&b.push(f),i.transports.console({data:b,date:new Date,level:g})}function a(p){s();const f=n.resolvePathFn(r,p);return e.provide({filePath:f,writeAsync:!n.sync,writeOptions:n.writeOptions})}function l({fileFilter:p=f=>f.endsWith(".log")}={}){s();const f=N.dirname(n.resolvePathFn(r));return $.existsSync(f)?$.readdirSync(f).map(g=>N.join(f,g)).filter(p).map(g=>{try{return{path:g,lines:$.readFileSync(g,"utf8").split(jt.EOL)}}catch{return null}}).filter(Boolean):[]}}function Jt(i=process.type){switch(i){case"renderer":return"renderer.log";case"worker":return"worker.log";default:return"main.log"}}const{maxDepth:Gt,toJSON:Yt}=k,{transform:Xt}=C;var Kt=Qt;function Qt(i,{externalApi:e}){return Object.assign(t,{depth:3,eventId:"__ELECTRON_LOG_IPC__",level:i.isDev?"silly":!1,transforms:[Yt,Gt]}),e!=null&&e.isElectron()?t:void 0;function t(r){var n;((n=r==null?void 0:r.variables)==null?void 0:n.processType)!=="renderer"&&(e==null||e.sendIpc(t.eventId,{...r,data:Xt({logger:i,message:r,transport:t})}))}}const Zt=Oe,er=we,{transform:tr}=C,{removeStyles:rr}=q,{toJSON:nr,maxDepth:ir}=k;var sr=or;function or(i){return Object.assign(e,{client:{name:"electron-application"},depth:6,level:!1,requestOptions:{},transforms:[rr,nr,ir],makeBodyFn({message:t}){return JSON.stringify({client:e.client,data:t.data,date:t.date.getTime(),level:t.level,scope:t.scope,variables:t.variables})},processErrorFn({error:t}){i.processMessage({data:[`electron-log: can't POST ${e.url}`,t],level:"warn"},{transports:["console","file"]})},sendRequestFn({serverUrl:t,requestOptions:r,body:n}){const o=(t.startsWith("https:")?er:Zt).request(t,{method:"POST",...r,headers:{"Content-Type":"application/json","Content-Length":n.length,...r.headers}});return o.write(n),o.end(),o}});function e(t){if(!e.url)return;const r=e.makeBodyFn({logger:i,message:{...t,data:tr({logger:i,message:t,transport:e})},transport:e}),n=e.sendRequestFn({serverUrl:e.url,requestOptions:e.requestOptions,body:Buffer.from(r,"utf8")});n.on("error",s=>e.processErrorFn({error:s,logger:i,message:t,request:n,transport:e}))}}const te=Qe,ar=tt,cr=nt,lr=St,pr=qt,fr=Kt,hr=sr;var ur=dr;function dr({dependencies:i,initializeFn:e}){var r;const t=new te({dependencies:i,errorHandler:new ar,eventLogger:new cr,initializeFn:e,isDev:(r=i.externalApi)==null?void 0:r.isDev(),logId:"default",transportFactories:{console:lr,file:pr,ipc:fr,remote:hr},variables:{processType:"main"}});return t.default=t,t.Logger=te,t.processInternalErrorFn=n=>{t.transports.console.writeFn({message:{data:["Unhandled electron-log error",n],level:"error"}})},t}const gr=m,mr=Me,{initialize:Er}=ze,yr=ur,H=new mr({electron:gr}),z=yr({dependencies:{externalApi:H},initializeFn:Er});var br=z;H.onIpc("__ELECTRON_LOG__",(i,e)=>{e.scope&&z.Logger.getInstance(e).scope(e.scope);const t=new Date(e.date);he({...e,date:t.getTime()?t:new Date})});H.onIpcInvoke("__ELECTRON_LOG__",(i,{cmd:e="",logId:t})=>{switch(e){case"getOptions":return{levels:z.Logger.getInstance({logId:t}).levels,logId:t};default:return he({data:[`Unknown cmd '${e}'`],level:"error"}),{}}});function he(i){var e;(e=z.Logger.getInstance(i))==null||e.processMessage(i)}const Sr=br;var vr=Sr;const c=Te(vr);c.initialize();let A=d.dirname(U.fileURLToPath(typeof document>"u"?require("url").pathToFileURL(__filename).href:y&&y.tagName.toUpperCase()==="SCRIPT"&&y.src||new URL("main.js",document.baseURI).href));const ue=process.env.NODE_ENV;ue!=="development"&&(A=A.replace("\\app.asar\\dist-electron",""));const O=class O{constructor(){h(this,"db");c.info("[数据库进程] 数据库进程初始化");const e=d.join(A,"../data");c.info("[数据库进程] 数据文件存储文件夹位置：",e),E.existsSync(e)||E.mkdirSync(e);const t=d.join(e,"clipboard.db");c.info("[数据库进程] 数据文件存储位置：",t),this.db=new Se(t),this.initTables()}static getInstance(){return O.instance||(O.instance=new O),O.instance}initTables(){c.info("[数据库进程] 初始化数据库表开始"),this.db.exec(`
                    CREATE TABLE IF NOT EXISTS clipboard_items (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        content TEXT NOT NULL,
                        copy_time INTEGER NOT NULL,
                        is_topped BOOLEAN DEFAULT 0,
                        top_time INTEGER,
                        type TEXT DEFAULT 'text',
                        file_path TEXT
                    )
                `),this.db.exec(`
                    CREATE TABLE IF NOT EXISTS tags (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        name TEXT NOT NULL UNIQUE,
                        created_at INTEGER NOT NULL
                    )
                `),this.db.exec(`
                    CREATE TABLE IF NOT EXISTS item_tags (
                        item_id INTEGER,
                        tag_id INTEGER,
                        FOREIGN KEY (item_id) REFERENCES clipboard_items (id) ON DELETE CASCADE,
                        FOREIGN KEY (tag_id) REFERENCES tags (id) ON DELETE CASCADE,
                        PRIMARY KEY (item_id, tag_id)
                    )
                `),c.info("[数据库进程] 初始化数据库表完成")}close(){this.db.close()}addItem(e,t="text",r=null){c.info("[数据库进程] 剪贴板内容添加开始",[e,t,r]);try{let n=Date.now();c.info("[数据库进程] 设置初始复制时间:",n);try{this.db.transaction(()=>{if(c.info("[数据库进程] 事务开始"),t==="text")c.info("[数据库进程] 删除相同文本内容的旧记录"),this.db.prepare("DELETE FROM clipboard_items WHERE content = ? AND type = ?").run(e,t);else if(t==="image"&&r){c.info("[数据库进程] 查询相同图片路径的记录");const s=this.db.prepare("SELECT copy_time FROM clipboard_items WHERE type = ? AND file_path = ?").get("image",r);s&&(n=s.copy_time,c.info("[数据库进程] 找到相同图片路径记录，使用原复制时间:",n)),c.info("[数据库进程] 删除相同图片路径的旧记录"),this.db.prepare("DELETE FROM clipboard_items WHERE type = ? AND file_path = ?").run("image",r)}c.info("[数据库进程] 准备插入新的剪贴板记录"),this.db.prepare("INSERT INTO clipboard_items (content, copy_time, type, file_path) VALUES (?, ?, ?, ?)").run(e,n,t,r),c.info("[数据库进程] 事务执行完成")})(),c.info("[数据库进程] 事务提交成功")}catch(s){throw c.error("[数据库进程] 事务执行失败",s),s}c.info("[数据库进程] 剪贴板内容添加成功")}catch(n){throw c.error("[数据库进程] 剪贴板内容添加失败",n),n}finally{c.info("[数据库进程] 剪贴板内容添加完成")}}getAllItems(){return this.db.prepare("SELECT * FROM clipboard_items ORDER BY is_topped DESC, CASE WHEN is_topped = 1 THEN top_time ELSE copy_time END DESC").all()}getItemsByTag(e){return this.db.prepare("SELECT ci.* FROM clipboard_items ci INNER JOIN item_tags it ON ci.id = it.item_id INNER JOIN tags t ON it.tag_id = t.id WHERE t.name = ? ORDER BY ci.is_topped DESC, CASE WHEN ci.is_topped = 1 THEN ci.top_time ELSE ci.copy_time END DESC").all(e)}deleteItem(e){try{const t=this.db.prepare("SELECT type, file_path FROM clipboard_items WHERE id = ?").get(e);if(t&&t.type==="image"&&t.file_path)try{E.unlinkSync(t.file_path)}catch(r){console.error("删除临时图片文件失败:",r)}this.db.prepare("SELECT type, file_path FROM clipboard_items WHERE id = ?").run(e)}catch(t){throw t}}clearAll(){return new Promise(async(e,t)=>{try{let r;ue==="development"?r=d.join(A,"../config"):r=d.join(A,"./config"),c.info("[数据库进程] 配置文件目录:",r);const n=d.join(r,"settings.conf");c.info("[数据库进程] 配置文件路径:",n);const s=JSON.parse(E.readFileSync(n,"utf8"));c.info("[数据库进程] 读取到的配置:",s);const o=s.tempPath;c.info("[数据库进程] 正在获取所有图片记录...");const a=this.db.prepare("SELECT type, file_path FROM clipboard_items WHERE type = ?").all("image");c.info("[数据库进程] 开始删除图片文件...");for(const l of a)if(l.file_path)try{E.unlinkSync(l.file_path),c.info(`[数据库进程] 成功删除图片文件: ${l.file_path}`)}catch(p){console.error(`[数据库进程] 删除图片文件失败: ${l.file_path}`,p)}c.info("[数据库进程] 正在清空数据库记录..."),this.db.prepare("DELETE FROM clipboard_items").run(),E.existsSync(o)||(c.info("[数据库进程] 正在创建临时目录..."),E.mkdirSync(o,{recursive:!0,mode:511}),c.info("[数据库进程] 临时目录创建成功")),c.info("[数据库进程] 剪贴板内容和临时文件清理完成"),e()}catch(r){console.error("[数据库进程] 清空剪贴板时发生错误:",r),t(r)}})}toggleTop(e,t){this.db.prepare("UPDATE clipboard_items SET is_topped = ?, top_time = ? WHERE id = ?").run(t?1:0,t?Date.now():null,e)}searchItems(e,t){c.info("[数据库进程] 搜索剪贴板内容",[e,t]);let r="SELECT DISTINCT ci.* FROM clipboard_items ci";const n=[];return t&&t!==null&&(r+=" INNER JOIN item_tags it ON ci.id = it.item_id INNER JOIN tags t ON it.tag_id = t.id WHERE t.id = ? AND ci.content LIKE ?",n.push(`%${t}%`)),e&&e!==null&&e!==""&&(r+=" WHERE content LIKE ?",n.push(`%${e}%`)),r+=" ORDER BY ci.is_topped DESC, CASE WHEN ci.is_topped = 1 THEN ci.top_time ELSE ci.copy_time END DESC",c.info("[数据库进程] 搜索SQL:",r),this.db.prepare(r).all(n)}updateItemTime(e,t){this.db.prepare("UPDATE clipboard_items SET copy_time = ? WHERE id = ?").run(t,e)}addTag(e){this.db.prepare("INSERT INTO tags (name, created_at) VALUES (?, ?)").run(e,Date.now())}deleteTag(e){this.db.prepare("DELETE FROM tags WHERE id = ?").run(e)}getAllTags(){return this.db.prepare("SELECT * FROM tags ORDER BY created_at ASC").all()}addItemTag(e,t){this.db.prepare("INSERT INTO item_tags (item_id, tag_id) VALUES (?, ?)").run(e,t)}removeItemTag(e,t){this.db.prepare("DELETE FROM item_tags WHERE item_id = ? AND tag_id = ?").run(e,t)}getItemTags(e){return this.db.prepare("SELECT t.* FROM tags t INNER JOIN item_tags it ON t.id = it.tag_id WHERE it.item_id = ?").all(e)}bindItemToTag(e,t){const r=this.db.prepare("SELECT id FROM tags WHERE name = ?").get(t);if(!r)throw new Error("标签不存在");if(this.db.prepare("SELECT * FROM item_tags WHERE item_id = ? AND tag_id = ?").get(e,r.id)){c.info("[数据库进程] 标签已绑定");return}this.db.prepare("INSERT OR IGNORE INTO item_tags (item_id, tag_id) VALUES (?, ?)").run(e,r.id)}};h(O,"instance");let D=O,I=d.dirname(U.fileURLToPath(typeof document>"u"?require("url").pathToFileURL(__filename).href:y&&y.tagName.toUpperCase()==="SCRIPT"&&y.src||new URL("main.js",document.baseURI).href));c.info("[主进程] 程序文件夹位置",I);const de=process.env.NODE_ENV;c.info("[主进程] 运行环境：",process.env.NODE_ENV);de!=="development"&&(I=I.replace("\\app.asar\\dist-electron",""));function _r(){const i=ge(),e=JSON.parse(E.readFileSync(i,"utf8"));return c.info("[主进程] 读取到的配置:",e),e}function Or(i){const e=ge();E.writeFileSync(e,JSON.stringify(i,null,4))}function ge(){let i;de==="development"?i=d.join(I,"../config"):i=d.join(I,"./config"),c.info("[主进程] 配置文件目录:",i);const e=d.join(i,"settings.conf");return console.log("[主进程] 配置文件路径:",e),e}let F=d.dirname(U.fileURLToPath(typeof document>"u"?require("url").pathToFileURL(__filename).href:y&&y.tagName.toUpperCase()==="SCRIPT"&&y.src||new URL("main.js",document.baseURI).href));c.info("[主进程] 程序文件夹位置",F);process.env.APP_ROOT=d.join(F,"..");const j=process.env.VITE_DEV_SERVER_URL,wr=d.join(process.env.APP_ROOT,"dist-electron"),J=d.join(process.env.APP_ROOT,"dist");process.env.VITE_PUBLIC=j?d.join(process.env.APP_ROOT,"public"):J;const Tr=process.env.NODE_ENV;c.info("[主进程] 运行环境：",process.env.NODE_ENV);Tr!=="development"&&(F=F.replace("\\app.asar\\dist-electron",""));let u;const M=_r();function re(){u=new m.BrowserWindow({icon:d.join(process.env.VITE_PUBLIC,"electron-vite.svg"),webPreferences:{nodeIntegration:!0,contextIsolation:!0,preload:d.join(d.dirname(U.fileURLToPath(typeof document>"u"?require("url").pathToFileURL(__filename).href:y&&y.tagName.toUpperCase()==="SCRIPT"&&y.src||new URL("main.js",document.baseURI).href)),"preload.mjs")}});const i=M.theme||"light";c.info("[主进程] 读取到的主题配置:",i),u.webContents.on("did-finish-load",()=>{u==null||u.webContents.send("main-process-message",new Date().toLocaleString()),c.info("[主进程] 发送主题设置到渲染进程"),u==null||u.webContents.send("change-themes",i),c.info("[主进程] 窗口加载完成，开始监听剪贴板"),me()}),j?u.loadURL(j):u.loadFile(d.join(J,"index.html")),u.webContents.openDevTools({mode:"detach"}),u.on("closed",()=>{x&&(clearTimeout(x),x=null)})}m.ipcMain.handle("clear-items",async()=>(D.getInstance().clearAll(),!0));m.ipcMain.handle("search-items",async(i,e,t)=>(c.info("[主进程] 搜索剪贴板列表",e,t),D.getInstance().searchItems(e,t)));m.ipcMain.handle("update-themes",async(i,e)=>(c.info("[主进程] 更新主题",e),M.theme=e,Or(M),!0));m.app.on("window-all-closed",()=>{process.platform!=="darwin"&&(m.app.quit(),u=null)});const Lr=m.app.requestSingleInstanceLock();Lr?m.app.whenReady().then(()=>{re(),m.app.on("activate",()=>{m.BrowserWindow.getAllWindows().length===0&&re()})}):m.app.quit();m.app.on("window-all-closed",()=>{process.platform==="darwin"&&(c.info("[主进程] 关闭程序"),m.app.quit())});let ne=m.clipboard.readText(),V=m.clipboard.readImage().isEmpty()?null:m.clipboard.readImage().toPNG(),x=null;function me(){if(!u||u.isDestroyed()||!u.webContents||u.webContents.isDestroyed()){c.info("[主进程] 窗口或渲染进程不可用，跳过剪贴板检查");return}try{const i=m.clipboard.readText(),e=m.clipboard.readBuffer("FileNameW"),t=m.clipboard.readImage();if(!t.isEmpty()){const r=t.toPNG();if(V!==null&&Buffer.compare(r,V)!==0){c.info("[主进程] 检测到剪贴板中有图片"),c.info("[主进程] 检测到新的图片内容"),V=r;const s=Date.now(),o=d.join(M.tempPath||d.join(F,"temp"));let a=null;if(E.existsSync(o)){const p=E.readdirSync(o);for(const f of p)if(f.endsWith(".png")){const g=d.join(o,f),b=E.readFileSync(g);if(Buffer.compare(b,r)===0){a=g;break}}}else E.mkdirSync(o,{recursive:!0});let l;if(a?(l=a,c.info("[主进程] 找到相同内容的图片文件:",l)):(l=d.join(o,`clipboard_${s}.png`),E.writeFileSync(l,r),c.info("[主进程] 图片已保存到临时目录:",l)),u&&!u.isDestroyed()){const p=u.webContents;if(p&&!p.isDestroyed()){if(p.getProcessId()&&!p.isLoading())try{c.info("[主进程] 准备发送图片信息到渲染进程"),u.webContents.send("clipboard-file",{name:d.basename(l),path:l,type:"image",isNewImage:!a}),c.info("[主进程] 图片信息已发送到渲染进程")}catch(f){if(c.error("[主进程] 发送图片信息到渲染进程时出错:",f),!a)try{E.unlinkSync(l)}catch(g){c.error("[主进程] 清理临时文件时出错:",g)}}}else if(!a)try{E.unlinkSync(l)}catch(f){c.error("[主进程] 清理临时文件时出错:",f)}}}}if(i&&i!==ne&&(ne=i,D.getInstance().addItem(i,"text",null),u&&!u.isDestroyed()))try{const n=u.webContents;n&&!n.isDestroyed()&&n.send("clipboard-updated",i)}catch(n){c.error("[主进程] 发送文本消息时出错:",n)}if(e&&e.length>0)try{const n=e.toString("utf16le").replace(/\x00/g,"").split(`\r
`).filter(Boolean);if(u&&!u.isDestroyed()){const s=u.webContents;s&&!s.isDestroyed()&&n.forEach(o=>{const a=d.basename(o);s.send("clipboard-file",{name:a,path:o,type:"file"})})}}catch(r){c.error("[主进程] 处理剪贴板文件时出错:",r)}}catch(i){c.error("[主进程] 检查剪贴板时出错:",i)}x=setTimeout(me,100)}exports.MAIN_DIST=wr;exports.RENDERER_DIST=J;exports.VITE_DEV_SERVER_URL=j;
